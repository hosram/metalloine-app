<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>تبدیل سختی</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vazirmatn@33.003.4/Farsi-font-face.css">
  <style>
  /* … همان CSS تم تاریک (کوتاه‌شده برای فضا) … */
  </style>
</head>
<body>
<header id="topbar">
  <span class="logo"><span class="ring"></span><span class="brand">Metalloine</span></span>
</header>

<main style="max-width:420px;margin:0 auto">
  <form id="hardnessCard" class="card">
    <!-- ورودی‌ها -->
    <label class="row-2">مقدار<input id="h-val" type="number" placeholder="200" inputmode="decimal"></label>
    <label>از:<select id="h-from">
      <option value="HB">⚫ HB</option><option value="HRC">⬤ HRC</option>
      <option value="HRB">◯ HRB</option><option value="HV">◆ HV</option></select></label>
    <div style="display:flex;align-items:end;gap:4px">
      <label style="flex:1">به:<select id="h-to">
        <option value="HRC">⬤ HRC</option><option value="HB">⚫ HB</option>
        <option value="HRB">◯ HRB</option><option value="HV">◆ HV</option></select></label>
      <button id="swapBtn" type="button" class="btn-flat" aria-label="swap">↔︎</button>
    </div>
    <label class="row-2">جنس:<select id="h-mat">
      <option value="steel">فولاد</option><option value="cast_iron">چدن</option>
      <option value="aluminium">آلومینیوم</option><option value="copper">مس</option>
      <option value="brass">برنج</option><option value="phosphor_bronze">برنز فسفری</option></select></label>
    <button id="h-btn" class="btn-main row-2" type="button">محاسبه</button>
    <output id="h-out" class="row-2">—</output>
    <div id="warn" class="row-2"></div>
    <ul id="suggest" class="row-2" style="margin-top:8px;font-size:.8rem;list-style:none;padding:0"></ul>
  </form>

  <!-- جدول مرجع -->
  <details id="reference">
    <summary style="cursor:pointer;margin-top:1rem">جدول مرجع ASTM/ISO</summary>
    <input id="search" type="search" placeholder="جست‌وجو…" style="width:100%;margin-bottom:8px">
    <div id="tableBox" style="max-height:240px;overflow:auto;border:1px solid rgba(255,255,255,.2);border-radius:var(--r)">
      <table id="refTable" style="width:100%;border-collapse:collapse;font-size:.8rem">
        <thead><tr><th>ماده</th><th>HB</th><th>HRC</th><th>HRB</th><th>HV</th></tr></thead><tbody></tbody>
      </table>
    </div>
  </details>
</main>

<a href="index.html" class="btn-main btn-icon" style="display:block;width:90%;max-width:420px;margin:2rem auto;text-align:center">⬅ بازگشت به صفحهٔ اصلی</a>
<div id="copy-toast" style="position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:8px 16px;border-radius:var(--r);opacity:0;transition:.3s">کپی شد!</div>

<script type="module">
import DATA from './convertHardness.js'; // فقط برای نوع‌بندی؛ در run-time دوباره lazy-load می‌کنیم
</script>
<script type="module">
/* ---------- متغیّرها ---------- */
let hardness, gradesMap=null;
const $val=document.getElementById('h-val'), $from=document.getElementById('h-from'),
      $to=document.getElementById('h-to'),   $mat=document.getElementById('h-mat'),
      $out=document.getElementById('h-out'), $warn=document.getElementById('warn'),
      btnCalc=document.getElementById('h-btn'), swapBtn=document.getElementById('swapBtn'),
      toast=document.getElementById('copy-toast');

/* ---------- لود تنبل جداول گرید ---------- */
async function loadGrades(){
  if(gradesMap) return;
  const mats=['steel','cast_iron','aluminium','copper','brass','phosphor_bronze'];
  gradesMap={};
  await Promise.all(mats.map(m=>fetch(`${m}.json`).then(r=>r.json()).then(j=>gradesMap[m]=j)));
}

/* ---------- لود تنبل مبدّل ---------- */
async function loadHardness(){ if(!hardness) hardness = await import('./convertHardness.js'); }

/* ---------- انیمیشن عدد ---------- */
function animate(el,from,to){
  const d=600,s=Date.now(); (function step(){
    const p=Math.min((Date.now()-s)/d,1); el.textContent=(from+(to-from)*p).toFixed(1);
    if(p<1) requestAnimationFrame(step);
  })();
}

/* ---------- پیشنهاد گرید ---------- */
function showSuggestions(arr,scale){
  const ul=document.getElementById('suggest');
  ul.innerHTML = arr.length
    ? arr.map(g=>`<li>${g.name} | ${g.id} | ${scale} ${g[scale+'min']}-${g[scale+'max']}</li>`).join('')
    : '<li style="opacity:.6">گرید نزدیکی یافت نشد</li>';
}

/* ---------- به‌روزرسانی ---------- */
async function update(){
  const v=parseFloat($val.value); if(isNaN(v)){ $out.textContent='—'; return; }
  await loadHardness(); const res=hardness.convert(v,$from.value,$to.value,$mat.value);
  animate($out,parseFloat($out.dataset.prev)||0,res); $out.dataset.prev=res;

  await loadGrades();
  const δ=($from.value==='HB'?5:2), list=gradesMap[$mat.value]||[], scale=$from.value;
  const near=list.filter(g=>{const lo=g[scale+'min'],hi=g[scale+'max'];return lo!=null&&hi!=null&&v>=lo-δ&&v<=hi+δ;}).slice(0,5);
  showSuggestions(near,scale);

  $warn.textContent = (scale==='HRB' && $mat.value==='steel') ? 'HRB برای فولاد سخت‌شده معمول نیست.' : '';
}

/* ---------- رویدادها ---------- */
['input','change'].forEach(ev=>[$val,$from,$to,$mat].forEach(el=>el.addEventListener(ev,update)));
btnCalc.addEventListener('click',update);
swapBtn.addEventListener('click',()=>{[$from.value,$to.value]=[$to.value,$from.value];update();});
$out.addEventListener('click',async()=>{if($out.textContent!=='—'){await navigator.clipboard.writeText($out.textContent);toast.style.opacity='1';setTimeout(()=>toast.style.opacity='0',1200);}});

/* ---------- جدول مرجع ---------- */
document.getElementById('reference').addEventListener('toggle', async e=>{
  if(e.target.open && !document.querySelector('#refTable tbody').children.length){
    await loadGrades(); await loadHardness();
    const tbody=document.querySelector('#refTable tbody');
    Object.entries(gradesMap).forEach(([mat,rows])=>{
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${mat}</td><td>${r.HBmin??'—'}-${r.HBmax??'—'}</td>
                       <td>${r.HRCmin??'—'}-${r.HRCmax??'—'}</td>
                       <td>${r.HRBmin??'—'}-${r.HRBmax??'—'}</td>
                       <td>${r.HVmin??'—'}-${r.HVmax??'—'}</td>`;
        tbody.appendChild(tr);
      });
    });
  }
});
document.getElementById('search').addEventListener('input',e=>{
  const q=e.target.value.trim(); document.querySelectorAll('#refTable tbody tr').forEach(tr=>{
    tr.style.display=tr.textContent.includes(q)?'':'none';
  });
});
</script>
</body></html>
