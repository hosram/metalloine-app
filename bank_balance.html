<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>جمع چک‌های پرداختی هر بانک به تفکیک | حسابفا</title>

  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/vazirmatn@33.003.4/Farsi-font-face.css"
  />
  <style>
    body {
      margin: 0; padding: 0;
      background: #000; color: #fff;
      font-family: "Vazirmatn", sans-serif;
      min-height: 100vh; line-height: 1.6;
    }
    .container {
      max-width: 500px; margin: 0 auto; padding: 16px;
    }
    h1 { margin-bottom: 12px; }
    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(12px);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 16px; margin-top: 12px;
    }
    .btn {
      display: inline-block;
      padding: 10px 18px;
      border-radius: 8px;
      border: none; 
      cursor: pointer;
      background: linear-gradient(135deg, #8E1F61, #8FA2B2);
      color: #fff; font-weight: 700;
      text-decoration: none;
      margin-top: 8px;
    }
    .status {
      margin-top: 10px; 
      color: #ff8888;
      min-height: 1.2em;
    }
    .bank-row {
      background: #111;
      border-radius: 8px;
      padding: 8px 12px;
      margin-top: 8px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .bank-row h3 {
      margin-bottom: 4px; 
      font-size: 1.1rem; 
      color: #ffd966;
    }
    .bank-row .sum-checks {
      color: #8aff8a; /* رنگ سبز */
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>جمع چک‌های پرداختی هر بانک در یک ماه آینده</h1>
    <div class="card">
      <p>با کلیک روی دکمه زیر، از حسابفا چک‌ها دریافت می‌شود. سپس براساس نام بانک، گروه‌بندی شده و جمع چک‌های مربوط به یک ماه آینده در هر بانک جداگانه نمایش داده می‌شود.</p>
      <button id="fetchBtn" class="btn">دریافت و گروه‌بندی چک‌ها</button>
      <div id="status" class="status"></div>

      <!-- اینجا لیست بانک‌ها درج می‌شود -->
      <div id="banksList"></div>
    </div>
  </div>

  <script>
    // API Key و Login Token
    const API_KEY = "XYeyCb0ImFsL8hr97IjLcJyBy7NImVm4";
    const LOGIN_TOKEN = "09a16a9e8feb473bacb8ccfe1a0b2ecac9798d486193bac994022ba9e4697524d5b8de6dec5ad2af79cbae77d4ca2af0";

    // آدرس سرویس حســابفا
    const HESABFA_CHECKS_URL =
      "https://app.hesabfa.com/app/d4579cf1a94d6a693b8ab660089b8297y1/paid-checks-list";

    // تابع تشخیص یک ماه آینده (از امروز تا امروز+۱ ماه)
    function getStartOfToday() {
      const d = new Date();
      d.setHours(0,0,0,0);
      return d;
    }
    function getEndOfNextMonth() {
      const d = getStartOfToday();
      d.setMonth(d.getMonth() + 1);
      d.setHours(23,59,59,999);
      return d;
    }
    function isCheckInNextMonth(dueDateString) {
      const due = new Date(dueDateString);
      const start = getStartOfToday();
      const end   = getEndOfNextMonth();
      return (due >= start && due <= end);
    }

    /*
      از پاسخ JSON حسابفا فیلد bankName را می‌خوانیم (مثلاً chk.bankName).
      اگر فیلد دیگری برای تشخیص بانک است، اصلاح کنید.
    */

    async function fetchAndGroupChecks() {
      const statusEl  = document.getElementById("status");
      const banksList = document.getElementById("banksList");
      statusEl.textContent  = "در حال دریافت اطلاعات چک‌ها...";
      banksList.innerHTML   = "";

      try {
        const resp = await fetch(HESABFA_CHECKS_URL, {
          method: "GET",
          headers: {
            "Api-Key": API_KEY,
            "Authorization": `Bearer ${LOGIN_TOKEN}`,
            "Content-Type": "application/json"
          }
        });

        if (!resp.ok) {
          throw new Error("خطا در پاسخ سرور (status=" + resp.status + ")");
        }

        const data = await resp.json();
        console.log("داده‌های دریافتی:", data);

        // 1) گروه‌بندی براساس نام بانک
        // یک شیء یا Map خواهیم داشت که کلید = bankName و مقدار = آرایه چک‌های متعلق به آن بانک
        const bankGroups = {};
        for (let chk of data) {
          // اگر فیلدی به نام chk.bankName نداریم، با console.log(chk) بررسی و اصلاح کنید.
          const bName = chk.bankName || "بدون بانک";
          if (!bankGroups[bName]) {
            bankGroups[bName] = [];
          }
          bankGroups[bName].push(chk);
        }

        // 2) حالا از بانکGroups می‌گذریم و جمع چک‌های یک ماه آینده را حساب می‌کنیم
        for (let bankName in bankGroups) {
          let sum = 0;
          for (const c of bankGroups[bankName]) {
            if (c.dueDate && c.amount && isCheckInNextMonth(c.dueDate)) {
              sum += c.amount;
            }
          }
          // یک سطر (بلوک) برای نمایش هر بانک
          const row = document.createElement("div");
          row.className = "bank-row";
          row.innerHTML = `
            <h3>${bankName}</h3>
            <div>مجموع چک‌های یک ماه آینده: 
              <span class="sum-checks">${sum.toLocaleString("fa-IR")} ریال</span>
            </div>
          `;
          banksList.appendChild(row);
        }

        statusEl.textContent = "";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "خطا: " + err.message;
      }
    }

    document.getElementById("fetchBtn").addEventListener("click", fetchAndGroupChecks);
  </script>
</body>
</html>
